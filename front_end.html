<html>
  <!--
    Copyright (c) 2013 Anthony Bau
    MIT License: http://opensource.org/licenses/MIT
  -->
  <head>
    <title>ECC Idea Forum</title>
    <style>
      body {
        padding-top:40px;
        overflow:hidden;
      }
      #top {
        height:30%;
      }
      #main {
        float:left;
        border:1px solid #000;
        padding:25px;
        border-radius: 5px;
        font-family:arial;
        overflow:visible;
        height:150px;
      }
      #main_header {
        border-bottom:1px solid goldenrod;
        margin-left:-10px;
        margin-bottom:20px;
        font-family:arial;
        font-size:30px;
        height:30px;
      }
      #panel {
        padding:10px;
        float:right;
        border:1px solid #000;
        border-radius: 5px;
        font-family:arial;
        overflow:auto;
        height:180px;
      }
      #bar {
        padding:0px;
        background-color:#800;
        position:absolute;
        left:0;
        top:0;
        width:100%;
        height:30px;
        line-height:30px;
      }
      #seal {
        margin-top:2px;
        margin-bottom:auto;
        margin-left:5px;
        height:25px;
        width:36px;;
      }
      #bottom {
        margin-top: 20px;
        height:100%;
        border:1px solid #000;
        border-radius:5px;
      }
      #items {
        overflow:auto;
      }
      .item {
        font-family:arial;
        border-bottom: 1px solid #000;
        padding:5px;
        cursor:hand;
      }
      #name {
        border:1px solid black;
        border-radius:2px;
        width:100%;
        height:20px;
        color:#888;
      }
      #description {
        width:100%;
        margin-top:10px;
        height:115px;
        border-radius: 2px;
        font-family:arial;
        color:#888;
      }
      #submit_button {
        width:100%;
        background-color:#aaa;
        margin-top:10px;
        height:25px;
        font-family:arial;
        font-size:18px;
        cursor:hand;
        border-radius:5px;
        border:none;
      }
      #submit_button:hover {
        background-color:#888;
      }
      #upvote, #downvote {
        height:25px;
        border:none;
        border-radius:4px;
        cursor:hand;
        font-family:arial;
        font-size:18px;
        color:#fff;
      }
      #votey {
        height:20px;
      }
      #main_body {
        height:78px;
        overflow:auto;
      }
      #upvote {
        background-color:#080;
      }
      #upvote:hover {
        background-color:#050;
      }
      #downvote {
        background-color:#800
      }
      #downvote:hover {
        background-color:#500;
      }
      .toolbar {
        padding-left:5px;
        padding-right:5px;
        color:white;
        font-family:arial;
        font-size:18px;
        height:100%;
        cursor:hand;
        float:left;
        width:auto;
      }
      .order {
        font-size:18px;
        padding-left:5px;
        padding-right:5px;
        height:30px;
        float:left;
        width:auto;
        cursor:hand;
        line-height:30px;
      }
      .order:hover {
        background-color:#811;
      }
      #order_by {
        height:30px;
        width:100%;
        border-bottom: 1px solid #000;
        font-family:arial;
        background-color:#922;
      }
      #sort {
        background:#300;
        color:#fff;
        float:left;
        height:100%;
        padding-left:5px;
        padding-right:5px;
        width:auto;
        line-height:30px;
        font-size:18px;
      }
      .cursored {
        background-color:#a99;
      }
      .toolbar:hover {
        background-color:#500;
      }
      .toolbar_link {
        color:inherit;
        text-decoration:none;
      }
      .item:hover {
        background: #aaa;
      }
      #before_upload {
        float:left;
      }
      #upload {
        float:left;
      }
      .qq-uploader {
        background-color:#333;
        height:25px;
        font-family:arial;
        font-size:18px;
        border-radius:5px;
        color:#fff;
        padding-left:5px;
        padding-right:5px;
        margin-left:5px;
        margin-right:5px;
      }
      .qq-uploader:hover {
        background-color:#222;
      }
      .qq-upload-button {
        height:100%;
        line-height:25px;
      }
      #prototypes {
        height:25px;
        overflow:hidden;
        border:1px solid #000;
        border-radius:5px;
        background-color:#fff;
        margin-left:5px;
      }
      #prototypes:hover {
        height:auto;
        max-height:500px;
      }
      .prototype_link {
        display:block;
        height:25px;
        line-height:25px;
        font-family:arial;
        padding-left:5px;
      }
      .qq-drop-processing, .qq-upload-list {
        display:none;
      }
    </style>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="/file/jquery.fineuploader-3.3.1.min.js"></script>
    <script src="/file/iframe.xss.response-3.3.1.js"></script>
    <script>
      var order = "timestamp DESC";
      $(function() {
        $(window).resize(function() {
          var bottom = $("#bottom"),
              items = $("#items"),
              top = $("#top"),
              main = $("#main"),
              panel = $("#panel");
          top.height(main.outerHeight());
          main.width(0.7*top.width() - 52 - 5);
          panel.width(0.3*top.width() - 22 - 5);
          bottom.height(window.innerHeight - bottom.offset().top - 30);
          items.height(bottom.height() - 30);
        }).resize();
        
        function reload() {
          $(".item").remove();
          console.log(order);
          $.ajax({
            url:"/load?order_by=" + encodeURIComponent(order),
            dataType:"json"
          }).done(function(data) {
            var bottom = $("#items");
            for (var i = 0; i < data.length; i += 1) {
              var new_element = $("<div class=\"item\"></div>")
                .text(data[i][2])
                .attr({"rowid":data[i][0],"timestamp":data[i][1],"description":data[i][3], "upvotes":data[i][4], "downvotes":data[i][5],"codefiles":data[i][6]})
                .click(function() {
                  var j_this = $(this),
                      j_links = $("#prototypes"),
                      codefiles = j_this.attr("codefiles").split(";");
                  codefiles.shift();
                  console.log(codefiles);
                  $(".prototype_link").remove();
                  $(".cursored").removeClass("cursored");
                  j_this.addClass("cursored");
                  $("#main").attr({"rowid":j_this.attr("rowid"),"timestamp":j_this.attr("timestamp")});
                  $("#main_header").text(j_this.text());
                  $("#main_body").text(j_this.attr("description"));
                  $("#upvote_number").text(j_this.attr("upvotes"));
                  $("#downvote_number").text(j_this.attr("downvotes"));
                  for (var i = 0; i < codefiles.length; i += 1) {
                    j_links.append($("<div class=\"prototype\"><a class=\"prototype_link\" href=\"/file/" + codefiles[i] + "\">" + codefiles[i].split("/")[2] + "</a></div>"));
                  }
                });
              if (new_element.attr("rowid") == $("#main").attr("rowid")) {
                new_element.addClass("cursored");
              }
              bottom.append(new_element);
              if (!$("#main").attr("rowid")) {
                $(".item").first().click();
              }
            }
            $(".item[rowid="+$("#main").attr("rowid")+"]").click();
          });
        }
        
        reload();
        
        
        $("#name, #description").each(function() { this.grayed = true});

        $("#name").focus(function() {
          j_this = $(this);
          if (j_this[0].grayed === true) {
            j_this[0].grayed = false;
            j_this.css("color","#000");
            j_this.val("");
          }
        }).blur(function() {
          j_this = $(this);
          if (j_this.val() === "") {
            j_this[0].grayed = true;
            j_this.css("color", "#888");
            j_this.val("title");
          }
        });
        $("#description").focus(function() {
          j_this = $(this);
          if (j_this[0].grayed === true) {
            j_this[0].grayed = false;
            j_this.css("color","#000");
            j_this.val("");
          }
        }).blur(function() {
          j_this = $(this);
          if (j_this.val() === "") {
            j_this[0].grayed = true;
            j_this.css("color", "#888");
            j_this.val("description");
          }
        });
        $("#submit_button").click(function() {
          $.ajax({
            "url":"/submit?name=" + encodeURIComponent($("#name").val()) + "&description=" + encodeURIComponent($("#description").val())
          }).done(function() {
            reload();
            $("#name, #description").val("");
            $("#name, #description").blur();
          });
        });
        $("#downvote").click(function() {
          $.ajax({
            url: "/downvote?rowid=" + $("#main").attr("rowid")
          }).done(function() {
            reload();
            $("#downvote_number").text((Number($("#downvote_number").text())+1));
          });
        });
        $("#upvote").click(function() {
          $.ajax({
            url: "/upvote?rowid=" + $("#main").attr("rowid")
          }).done(function() {
            reload();
            $("#upvote_number").html((Number($("#upvote_number").text())+1));
          });
        });
        $("#order_time").click(function() {
          order = "timestamp";
          reload();
        });
        $("#order_votes").click(function() {
          order = "votes";
          reload();
        });
        $("#order_alphabetic").click(function() {
          order = "name";
          reload();
        });
        var uploader = $("#upload").fineUploader({
          dragAndDrop:{
            disableDefaultDropzone:true
          },
          text:{
            uploadButton:"&oplus; upload proof-of-concept"
          },
          request:{
            params:{
              rowid:function() {
                return $("#main").attr("rowid");
              }
            },
            paramsInBody:false,
            endpoint:"/save"
          }
        }).on("complete",reload);
        console.log(uploader);
      });
    </script>
  </head>
  <body>
    <div id="bar">
      <div class="toolbar">
        <a href="https://github.com/Exeter" class="toolbar_link">github</a>
      </div>
    </div>
    <div id = "top">
      <div id = "main">
        <div id="main_header">
        </div>
        <div id="main_body">
        </div>
        <div id="votey">
          <div id="before_upload">
            <button id="upvote">&uarr; <span id="upvote_number"></span></button>
            <button id="downvote">&darr; <span id="downvote_number"></span></button>
          </div>
          <div id="upload"></div>
          <div id="prototypes"></div>
        </div>
      </div>
      <div id = "panel">
        <div>
          <input id="name" value="title"/>
        </div>
        <div>
          <textarea id="description">description</textarea>
        </div>
        <button id="submit_button">
          submit new idea
        </button>
      </div>
    </div>
    <div id = "bottom">
      <div id = "order_by">
        <div id = "sort">
          sort by 
        </div>
        <div id = "order_time" class = "order">
          time
        </div>
        <div id = "order_votes" class = "order">
          votes
        </div>
        <div id = "order_alphabetic" class = "order">
          alphabetic
        </div>
      </div>
      <div id = "items">
      </div>
    </div>
  </body>
</html>
